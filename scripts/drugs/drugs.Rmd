---
title: "Drugs AMR"
author: "Emma Mendelsohn"
date: "9/26/2018"
output:
      html_document:
        keep_md: true
---
```{r}
knitr::opts_chunk$set(include=TRUE, echo=TRUE, message=FALSE, warning=FALSE)
```

```{r}
library(tidyverse)
library(magrittr)
library(stringi)
library(here)

load(here("data", "segments_db.RData")) #data compiled in 03_clean_segments.r
excluded_studies <- unique(segments_db$study_id[segments_db$code_main_cat=="Exclusion"])
segments_db %<>%
  filter(!study_id %in% excluded_studies) 

```
Initial clean-up
```{r}

sub_names <- tribble( 
  ~old,                    ~new,
  "\r\n",                    "",
  "- ",                      ""
)

dat <- segments_db %>%
  filter(code_main == "Drug Resisted") %>%
  mutate(segment = stri_replace_all_regex(tolower(segment),  sub_names$old, sub_names$new, vectorize_all = FALSE),
         code_identifiers = ifelse(is.na(code_identifiers), "", code_identifiers)) %>%
  select(-code_main_cat)

#unique(dat$segment)
```

Ontologies at the Comprehensive Antibiotic Resistance Database are freely available under
the Creative Commons CC-BY license version 4.0, https://creativecommons.org/licenses/by/4.0/
```{r}
# ARO - The Antibiotic Resistance Ontology that serves as the primary organizing principle 
# of the CARD.
aro <- jsonlite::fromJSON(here("scripts", "drugs", "card-ontology", "aro.json")) %>%
  rename(segment = name, aro_accession = accession, aro_description = description)
dat<- left_join(dat, aro) %>%
  mutate(aro_name = ifelse(is.na(aro_accession), NA, segment))
#fluoroquinolones is a class
#co-trimoxazole is Trimethoprim or sulfamethoxazole, both of which are in db
```
MeSH Medical Subject Headings (https://meshb.nlm.nih.gov/search)
```{r}
mesh0 <- read_csv(here("scripts", "drugs", "mesh-ontology", "MESH.csv")) #downloaded from bioportal
mesh <- mesh0 %>%
  mutate_all(tolower) %>%
  select(`Class ID`, `Preferred Label`, Synonyms, Definitions) %>%
  mutate(cat_split = str_split(Synonyms, "\\|")) %>%
  unnest() %>%
  mutate(cat_split = str_trim(cat_split)) %>%
  select(-Synonyms) %>%
  rename(Synonyms = cat_split)

pref_names <- unique(mesh$`Preferred Label`)
syn_names <- unique(mesh$Synonyms)
mesh <- mesh[!mesh$Synonyms %in% pref_names,] #filter out synonymns that are also primary names

mesh_r <- mesh %>%
  gather(key="mesh_segment_class", value="segment", `Preferred Label`, Synonyms, -`Class ID`, -Definitions) %>%
  rename(mesh_class_id = `Class ID`, mesh_definitions=Definitions) %>%
  unique() %>%
  filter(rowSums(is.na(.)) != ncol(.))

mesh_syn <- mesh %>%
  select(`Preferred Label`, Synonyms) %>%
  na.omit()  
out <- left_join(dat, mesh_r) %>%
  left_join(., mesh_syn, by = c("segment"="Synonyms")) %>%
  rename(mesh_name = `Preferred Label`) %>%
  mutate(mesh_name = ifelse(mesh_segment_class=="Synonyms", mesh_name, segment))

write.csv(out, "drug_card_mesh_ontology.csv", row.names = F)
out2 <- out[c(is.na(out$aro_accession) & is.na(out$mesh_class_id)),]
write.csv(out2, "missing_drug_ontology.csv", row.names = F)

unique(out[,c("aro_name", "mesh_name")])
```
MeSH test archive
```{r}
# endpoint <- "http://id.nlm.nih.gov/mesh/sparql"
# q <-
#  'PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
# PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
# PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
# PREFIX owl: <http://www.w3.org/2002/07/owl#>
# PREFIX meshv: <http://id.nlm.nih.gov/mesh/vocab#>
# PREFIX mesh: <http://id.nlm.nih.gov/mesh/>
# PREFIX mesh2015: <http://id.nlm.nih.gov/mesh/2015/>
# PREFIX mesh2016: <http://id.nlm.nih.gov/mesh/2016/>
# PREFIX mesh2017: <http://id.nlm.nih.gov/mesh/2017/>
# PREFIX mesh2018: <http://id.nlm.nih.gov/mesh/2018/>
# 
# SELECT * 
# FROM <http://id.nlm.nih.gov/mesh>
# WHERE {
#   mesh:D015242 meshv:pharmacologicalAction ?pa .
#   ?pa rdfs:label ?paLabel .
# }
# '
# 
# page <- httr::GET(paste0(endpoint, "?query=", URLencode(q, reserved = TRUE), "&format=CSV"))
# test <- httr::content(page)
```
