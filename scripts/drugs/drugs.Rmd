---
title: "Drugs AMR"
author: "Emma Mendelsohn"
date: "9/26/2018"
output:
      html_document:
        keep_md: true
---
```{r}
knitr::opts_chunk$set(include=TRUE, echo=TRUE, message=FALSE, warning=FALSE)
```

```{r}
library(tidyverse)
library(magrittr)
library(stringi)
library(here)
library(googlesheets)

load(here("data", "segments_db.RData")) #data compiled in 03_clean_segments.r
sub_names <- gs_read(gs_title("amr_db_clean_drugs")) %>% as.tibble() %>% filter(new!="--") #google spreadsheet with field cleanup
sub_names$segment <- paste0("^", sub_names$segment, "$")
dat <- segments_db %>%
  filter(code_main == "drug resisted") %>%
  mutate(segment = gsub("\\(|\\)", "", segment))
```
Data clean up
```{r}
dat %<>% 
  mutate(segment = gsub("\\+|\\â€“", "/", segment)) %>%
  mutate(segment = gsub("\\:|\\;|\006|\002|\\.|\\,", "", segment)) %>%
  mutate(segment = str_trim(segment)) %>%
  mutate(segment = stri_replace_all_regex(segment,  sub_names$segment, sub_names$new, vectorize_all = FALSE)) %>%
  mutate(segment_combo = ifelse(grepl("\\/", segment), TRUE, FALSE)) %>%
  mutate(segment = str_split(segment, "\\/")) %>%
  unnest()
  
#testing
# name <- "vancomycin"
# mesh[mesh$segment==name,]
# mesh[mesh$mesh_id=="D002438",]
# mesh[grepl(name, mesh$segment),]
```


MeSH Medical Subject Headings (https://meshb.nlm.nih.gov/search)
```{r}
mesh0 <- read_csv(here("scripts", "drugs", "mesh-ontology", "MESH.csv")) %>% #downloaded from bioportal: https://bioportal.bioontology.org/ontologies/MESH?p=summary
  mutate_at(vars(`Class ID`, Parents), funs(gsub("http://purl.bioontology.org/ontology/MESH/", "", .))) %>%
  mutate_at(vars(`Preferred Label`, Synonyms), tolower) 

#mesh clean and reshape
mesh <- mesh0 %>%
  select("Class ID" ,"Preferred Label","Synonyms", "Definitions", "HM", "Parents", "PA") %>%
  mutate(Synonyms = str_split(Synonyms, "\\|")) %>%
  unnest() %>%
  gather(key="segment_class", value="segment", `Preferred Label`, Synonyms, 
         -`Class ID`, -Definitions, -HM, -Parents, -PA) %>%
  unique() %>%
  filter(!is.na(segment)) %>% #cases with no synonyms
  rename_all(tolower) %>%
  setNames(paste0('mesh_', names(.)))  %>%
  rename(mesh_id = `mesh_class id`, segment = mesh_segment)

pref_names <- unique(mesh$segment[mesh$mesh_segment_class=="Preferred Label"])
syn_names <- unique(mesh$segment[mesh$mesh_segment_class=="Synonyms"])
mesh <- mesh[!c(mesh$segment %in% pref_names & mesh$mesh_segment_class=="Synonyms"),] #filter out synonymns that are also primary names

#join mesh with dat based on segment name
dat <- dat %>% left_join(., mesh) 

#name look ups
dat %<>%
  left_join(., mesh0 %>% select("Class ID", "Preferred Label" ), by=c("mesh_id"="Class ID")) %>%
  rename("mesh_preferred_label" = `Preferred Label`) %>%
  mutate(mesh_class = substr(`mesh_id`, 1, 1)) %>%
  mutate(mesh_class_desc = ifelse(mesh_class=="C", "supp", "desc")) %>%
  mutate(mesh_parent_id = ifelse(mesh_class=="C", mesh_hm, mesh_parents)) %>%
  separate(mesh_parent_id, c("mesh_parent_id", "mesh_parent_id_qualifier"), "/") %>% #warning is ok
  mutate(mesh_parent_id = str_split(mesh_parent_id, "\\|")) %>%  unnest() %>%
  mutate(mesh_pa_id = str_split(mesh_pa, "\\|")) %>%  unnest() %>%
  left_join(., mesh0 %>% select("Class ID", "Preferred Label" ), by=c("mesh_parent_id"="Class ID")) %>%
  rename("mesh_parent_name" = `Preferred Label`) %>%
  left_join(., mesh0 %>% select("Class ID", "Preferred Label" ), by=c("mesh_pa_id"="Class ID")) %>%
  rename("mesh_pa_name" = `Preferred Label`) %>%
  select(-mesh_hm, -mesh_parents, -mesh_pa)

#c = Class 1 Supplementary Records - Chemicals #These records are dedicated to chemicals and are primarily heading mapped to the D tree descriptors.
#d = D tree for drugs and chemicals,
#this dataframe currently provides immediate parents only
#use MN to get full tree - only works for D.  C lookup against D then full tree

dat_unique <- dat %>%
  select(-study_id, -code_identifiers, -code_main) %>%
  unique()
#19 drugs with no exact match
#length(unique(dat_unique$segment[is.na(dat_unique$mesh_id)]))

#128 drugs with exact match
#length(unique(dat_unique$segment[!is.na(dat_unique$mesh_id)]))

dat_unique %<>%
  filter(!is.na(mesh_id))  

```
Save data
```{r}
#all data
save(dat, file=here("scripts", "drugs", "drug_mesh_ontology.RData"))

#unrecognized names
outm <- dat %>%
  filter(is.na(mesh_id))%>%
  select(study_id, segment, code_identifiers) %>%
  group_by(segment) %>%
  summarize(study_id = paste(study_id, collapse = ", "))
#gs_new("amr_db_clean_drugs", input = outm)

#studies without drug names?
missing <- unique(segments_db$study_id[!segments_db$study_id %in% unique(dat$study_id)])
load(here("data", "articles_db.RData"))
sub_index <- articles_db %>%
  filter(study_id %in% missing) %>%
  select(study_id, mex_name)
#gs_new("amr_db_missing_drugs_study_id", input=sub_index)

```
