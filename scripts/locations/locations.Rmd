---
title: "Locations AMR"
author: "Emma Mendelsohn"
date: "9/19/2018"
output:
      html_document:
        keep_md: true
---
Setup
```{r setup}
knitr::opts_chunk$set(include=TRUE, echo=TRUE, message=FALSE)

library(tidyverse)
library(magrittr)
library(stringi)
library(mapview)
library(opencage)
library(googlesheets)
library(sf)
library(here)
#gs_auth(new_user = TRUE)

#Function for data manipulation
paste_collapse <- function(x){
  x <- x[!is.na(x) & x!=""]
  paste(x, collapse = ", ")
}

#wd <- gsub("scripts/locations", "data", getwd())
load(here("data", "coded_annotations.RData")) #data compiled in 03_clean_segments.r
field_corrections <- gs_read(gs_title("amr_db_field_corrections")) %>% as.tibble() #google spreadsheet tracking field corrections
sub_names1 <- gs_read(gs_title("amr_db_clean_locs")) %>% as.tibble() #google spreadsheet with field cleanup
```
Fix to mislabeled locations 
```{r}
field_corrections %<>%
  mutate(study_id=as.character(study_id)) %>%
  filter(requires_followup=="No") %>%
  select(-requires_followup, -notes)
codes %<>%
  left_join(.,field_corrections) %>%
  mutate(code_main = ifelse(is.na(code_main_new), code_main, code_main_new)) %>%
  select(-code_main_new) %>%
  filter(!study_id %in% unique(codes$study_id[codes$code_main_cat=="Exclusion"])) 
```
Manual Subsitutions
```{r}
sub_names2 <- tribble( #not handled well by google spreadsheet
  ~old,                    ~new,
  "\r\n",                  "",
  "- ",                    "",
  ",",                     "",
  "2",                     ""
)
sub_names <- bind_rows(sub_names2, sub_names1[sub_names1$field=="study_location",]) #combine with google doc

city_names  <- tribble( #add countries to cities missing country or state
  ~city,             ~country,
  "toronto",         "canada",
  "rio de janeiro",  "brazil",
  "santo domingo",   "dominican republic",
  "calgary",         "canada",
  "liverpool",       "united kingdom",
  "rome",            "italy"
)

state_names  <- tribble( #add countries to cities missing country or state
  ~"state/province/district",  ~country,
  "california",         "united states",
  "kanto",              "japan",
  "georgia",            "united states",
  "new york",           "united states"
)

```
Clean data
```{r}
dat <- codes %>% #reshape and clean names
  filter(code_main_cat=="Location") %>%
  spread(key = code_main, value = segment) %>%
  select(-matches_str) %>%
  unique() %>%
  group_by(code_main_cat, study_id, code_identifiers) %>%
  summarise_all(funs(paste_collapse)) %>%
  rename_all(tolower) %>%
  rename("hospital" = `hospital name`, "travel_location" = `place traveled to`) %>%
  mutate_all(funs(tolower)) %>%
  mutate_all(funs(gsub("\\(|\\)", "", .))) %>%
  mutate_at(vars(country, city, hospital, `state/province/district`), funs(stri_replace_all_regex(.,  sub_names$old, sub_names$new, vectorize_all = FALSE))) %>%
  mutate_all(funs(trimws(., "both"))) %>%
  ungroup() 

dat <- left_join(dat, city_names, by="city") %>% #assign countried to cities and states without countries
  mutate(country= ifelse(is.na(country.y), country.x, country.y)) %>%
  select(-country.y, -country.x) %>%
  left_join(., state_names, by="state/province/district") %>%
  mutate(country= ifelse(is.na(country.y), country.x, country.y)) %>%
  select(-country.y, -country.x) 

```
Evaluate data available
```{r}
pref <- c( #Order from most preferable to least
  "hospital_city_country",
  "hospital_city_state/province/district",
  "hospital_state/province/district_country",
  "hospital_city",
  "hospital_state/province/district",
  "hospital_country",
  "hospital",
  "city_country", 
  "city_state/province/district", 
  "state/province/district_country", 
  "city", 
  "state/province/district", 
  "country") #TODO"Place traveled to" 

dat <- as.data.frame(dat)
dat$geoloc_basis <- ""
dat$geoloc_value <- ""

#based on above preference order, assign basis for geocode (geoloc_basis) and extract location name (geoloc_value)
for (i in rev(seq_along(pref))){
  cnames <- strsplit(pref[i], "_") %>% unlist
  dat_avail <- apply(dat[,c("study_id", cnames)]!="", 1, all) #if all relevant columns have values
  dat$geoloc_basis <- ifelse(dat_avail, 
                             pref[i], 
                             dat$geoloc_basis)
  if(length(cnames)>1){
    dat$geoloc_value <- ifelse(dat_avail, 
                               apply(dat[, c(cnames)], 1 , paste, collapse = ", "),
                               dat$geoloc_value)
  }else{
    dat$geoloc_value <- ifelse(dat_avail, 
                               dat[, c(cnames)],
                               dat$geoloc_value)
  }
}

dat <- dat %>% select(-country, -city, -hospital, -`state/province/district`)
```

Geocode function for batch processing in opencage
```{r}
opencage_forward_mutate <- function(data, location){
  
  locs <- data[, location, drop = TRUE] #extract location
  
  out <- map(locs, opencage::opencage_forward, limit=1) #map opencage_forward function to locations
  
  gcdf <- data.frame() 
  for(i in seq_along(out)){
    tmp <- data.frame(lat = out[[i]]$results$geometry.lat,
                      lon = out[[i]]$results$geometry.lng)
    if(nrow(tmp)==0){tmp <- data.frame(lat=NA, lon=NA)}
    gcdf <- rbind(gcdf, tmp)
  }
  cbind(data, gcdf)
}
```
Geocode - study location
```{r}
gdat <- dat %>%
  opencage_forward_mutate(location = "geoloc_value") %>%
  rename(geoloc_lat = lat, geoloc_lon=lon)
  
gdat_sf <- st_as_sf(gdat %>% filter(!is.na(geoloc_lat)), coords = c("geoloc_lon", "geoloc_lat"), crs = 4326)
mapview(gdat_sf, zcol="geoloc_basis", col.regions = colorRampPalette(RColorBrewer::brewer.pal(9, "Set1")), alpha.regions=1)

```

Geocode - places traveled to
```{r}
sub_names2 <- tribble( #not handled well by google spreadsheet
  ~old,                    ~new,
  "\r\n",                  ""
)
sub_names <- bind_rows(sub_names2, sub_names1[sub_names1$field=="travel_location",]) #combine with google doc

do_not_split <- c("california, san francisco", "india, new delhi", "riyadh, saudi arabia", "new delhi, india", "mumbai, india", "karachi, pakistan", "cairo, egypt")

gdat <- gdat %>%
  mutate(travel_location = stri_replace_all_regex(travel_location,  sub_names$old, sub_names$new, vectorize_all = FALSE)) %>%
  mutate(travel_location = ifelse(is.na(travel_location), "", travel_location)) %>%
  mutate(travel_location = ifelse(travel_location %in% do_not_split, travel_location, gsub("\\,", "\\;", travel_location))) %>%
  mutate(cat_split = str_split(travel_location, ";")) %>%
  unnest() %>%
  mutate(cat_split = str_trim(cat_split)) %>%
  select(-travel_location) %>%
  group_by(study_id) %>%
  mutate(travel_location_id = paste0("loc_", row_number())) %>%
  rename(travel_location = cat_split) %>%
  ungroup() %>%
  opencage_forward_mutate(location = "travel_location") %>%
  rename(travel_lat = lat, travel_lon=lon)

gdat_sf <- st_as_sf(gdat %>% filter(!is.na(travel_lat)), coords = c("travel_lon", "travel_lat"), crs = 4326)
mapview(gdat_sf, col.regions = colorRampPalette(RColorBrewer::brewer.pal(9, "Set1")), alpha.regions=1)
```

Notes
```{r}
#For QA:
write.csv(gdat, "location_coords.csv",row.names = F)

#STUDIES THAT HAVE CODE IDENTIFIERS
gdat[!is.na(gdat$code_identifiers),]

#HOW MANY STUDIES DO NOT HAVE LOCS
codes %>% 
  group_by(study_id) %>% 
  summarize(segs = paste(unique(code_main_cat), collapse=", ")) %>%
  filter(!grepl("Location", segs)) %>%
  ungroup() %>% nrow()

#RESIDENCE
codes %>%
  filter(code_main=="Country of Residence")

#TODO issues
#TODO include residence (addition to geoloc_value)
#TODO handle locations with A, B etc identifiers

```
